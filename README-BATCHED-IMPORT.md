# Contentful Batched Migration Guide

This guide explains how to migrate large amounts of content and assets from one Contentful space to another using a batched approach to avoid rate limiting.

## Overview

**Problem:** Direct import of large Contentful exports (4,000+ assets, 11,000+ entries) causes rate limiting errors.

**Solution:** Split the export into manageable batches and import them sequentially with delays between batches.

## Project Structure

```
.
â”œâ”€â”€ batch-config.json              # Main configuration file
â”œâ”€â”€ contentful-export/             # Source export data
â”‚   â”œâ”€â”€ exported-space.json        # Full export (50MB)
â”‚   â”œâ”€â”€ assets.ctfassets.net/      # Asset files (145 files, 209MB)
â”‚   â”œâ”€â”€ downloads.ctfassets.net/   # Asset files (79 files, 1.9GB)
â”‚   â”œâ”€â”€ images.ctfassets.net/      # Asset files (3,895 files, 2.5GB)
â”‚   â””â”€â”€ videos.ctfassets.net/      # Asset files (1 file, 8.2MB)
â”œâ”€â”€ batches/                       # Generated by split script
â”‚   â”œâ”€â”€ batch-01/                  # First batch (includes content model)
â”‚   â”œâ”€â”€ batch-02/                  # Subsequent batches
â”‚   â””â”€â”€ manifest.json              # Batch metadata
â”œâ”€â”€ split-contentful-export.js     # Step 1: Split export into batches
â”œâ”€â”€ import-batches.js              # Step 2: Import batches sequentially
â”œâ”€â”€ validate-migration.js          # Step 3: Validate migration success
â””â”€â”€ resume-import.js               # Utility: Resume failed imports
```

## Prerequisites

1. **Node.js** (v14 or higher)
2. **Required packages:**
   ```bash
   npm install contentful-import contentful-management
   ```

3. **Contentful Management Token** for target space (EU region)
4. **Exported data** from source space (US region)

## Configuration

Edit `batch-config.json` to match your setup:

```json
{
  "batchSize": 600,                           // Assets per batch (500-700 recommended)
  "sourceFile": "./contentful-export/exported-space.json",
  "sourceAssetsDir": "./contentful-export",
  "outputDir": "./batches",
  "targetSpace": {
    "spaceId": "YOUR_TARGET_SPACE_ID",
    "environmentId": "stage",
    "managementToken": "YOUR_MANAGEMENT_TOKEN",
    "host": "api.eu.contentful.com"           // EU region
  },
  "importOptions": {
    "uploadAssets": true,
    "skipContentPublishing": false,
    "delayBetweenBatches": 180000,            // 3 minutes (in milliseconds)
    "maxRetries": 3,
    "retryDelay": 5000
  }
}
```

### Configuration Options

| Option | Description | Default |
|--------|-------------|---------|
| `batchSize` | Number of assets per batch | 600 |
| `delayBetweenBatches` | Wait time between batches (ms) | 180000 (3 min) |
| `maxRetries` | Number of retry attempts per batch | 3 |
| `retryDelay` | Initial retry delay (ms, exponential backoff) | 5000 |

## Step-by-Step Migration Process

### Step 1: Split the Export

Split the large export into manageable batches:

```bash
node split-contentful-export.js
```

**What it does:**
- Reads `contentful-export/exported-space.json`
- Analyzes asset-entry relationships
- Splits assets into batches (600 assets each)
- Groups related entries with their assets
- Copies asset files to batch directories
- Generates `batches/manifest.json`

**Expected output:**
```
ğŸš€ Starting Contentful Export Splitter...

ğŸ“– Reading source export file...
ğŸ“Š Source data summary:
  - Content Types: 60
  - Entries: 11985
  - Assets: 4126
  - Tags: 446
  - Locales: 1

ğŸ”— Building asset-entry relationship map...
ğŸ“¦ Splitting into batches of 600 assets...
  - Created 7 batches

ğŸ“‚ Processing Batch 01...
  - Assets: 600
  - Entries: 1250
  âœ… Created: batches/batch-01/exported-space.json
  ğŸ“ Copying asset files...
  âœ… Copied 598 asset files

...

âœ… Splitting completed successfully!
```

**Result:** Creates `batches/` directory with 7-8 batch subdirectories.

### Step 2: Import Batches

Import all batches sequentially:

```bash
node import-batches.js
```

**What it does:**
- Reads `batches/manifest.json`
- Imports batch 1 (includes content model)
- Imports batches 2-N (data only)
- Waits 3 minutes between batches
- Retries failed batches up to 3 times
- Logs progress to `batches/logs/`
- Saves state to `batches/import-state.json`

**Expected output:**
```
ğŸš€ Starting Contentful Batch Import...

ğŸ“‹ Found 7 batches to import

============================================================
ğŸ“¦ Importing Batch 01 of 7
============================================================

Batch info:
  - Assets: 600
  - Entries: 1250
  - Has content model: Yes
  - Directory: batches/batch-01

[contentful-import output...]

âœ… Batch 01 imported successfully!

â³ Waiting 180 seconds before next batch...

...

ğŸ“Š Import Summary
Total batches: 7
âœ… Successful: 7
âŒ Failed: 0

ğŸ‰ All batches imported successfully!
```

**Import time estimate:**
- Each batch: 10-15 minutes
- Total: 2-3 hours (including delays)

### Step 3: Validate Migration

Verify all content was migrated successfully:

```bash
node validate-migration.js
```

**What it does:**
- Compares source vs target counts
- Checks content types, entries, assets, tags, locales
- Reports differences and mismatches
- Provides recommendations for issues

**Expected output:**
```
ğŸ” Starting Migration Validation...

ğŸ“– Reading source export file...
ğŸ“Š Source data counts:
  - Content Types: 60
  - Entries: 11985
  - Assets: 4126
  - Tags: 446
  - Locales: 1

ğŸ”— Connecting to target space...
ğŸ“Š Target space counts:
  - Content Types: 60
  - Entries: 11985 (11850 published)
  - Assets: 4126 (4100 published)
  - Tags: 446
  - Locales: 1

ğŸ” Validation Results:
============================================================
âœ… Content Types         Source:     60 | Target:     60 | Diff: 0 (0.00%)
âœ… Entries               Source:  11985 | Target:  11985 | Diff: 0 (0.00%)
âœ… Assets                Source:   4126 | Target:   4126 | Diff: 0 (0.00%)
âœ… Tags                  Source:    446 | Target:    446 | Diff: 0 (0.00%)
âœ… Locales               Source:      1 | Target:      1 | Diff: 0 (0.00%)
============================================================

ğŸ“Š Validation Summary:
  âœ… Passed: 5
  âŒ Failed: 0
  âš ï¸  Warnings: 0

ğŸ‰ Validation passed! All data migrated successfully.
```

## Handling Failures

### Resume Failed Import

If the import fails or is interrupted:

```bash
node resume-import.js
```

**What it does:**
- Reads `batches/import-state.json`
- Shows completed and failed batches
- Automatically resumes from the correct batch
- Retries failed batches

**Options:**
- Automatically detects where to resume
- Waits 5 seconds before starting (Ctrl+C to cancel)

### Manual Resume from Specific Batch

```bash
node import-batches.js --start-from 4
```

Starts importing from batch 4 onwards.

## Troubleshooting

### Rate Limiting Errors (429)

**Symptom:** Import fails with rate limit errors

**Solutions:**
1. Increase `delayBetweenBatches` in `batch-config.json` (try 300000 = 5 minutes)
2. Reduce `batchSize` (try 400-500)
3. Wait longer between retry attempts

### Asset Upload Failures

**Symptom:** Some assets fail to upload

**Solutions:**
1. Check `batches/logs/batch-XX-errors.log` for specific errors
2. Verify asset files exist in `contentful-export/` directories
3. Check file permissions
4. Verify asset URLs in export JSON are not empty (see known issues)

### Memory Issues

**Symptom:** Script crashes with "Out of memory" error

**Solutions:**
```bash
# Increase Node.js memory limit
node --max-old-space-size=4096 split-contentful-export.js
node --max-old-space-size=4096 import-batches.js
```

### Validation Mismatches

**Symptom:** Source and target counts don't match

**Solutions:**
1. Check `batches/import-state.json` for failed batches
2. Review error logs in `batches/logs/`
3. Run `node resume-import.js` to retry failed batches
4. Manually inspect missing items in Contentful UI

## Known Issues

### Empty Asset URLs

Some assets in the export have empty URLs:
```
"assets[933].fields.file.nb-NO.url" is not allowed to be empty
```

**Workaround:** These assets are skipped during import. Manually fix in source space and re-export if needed.

## Advanced Usage

### Custom Batch Size

For smaller batches (slower but safer):
```json
{
  "batchSize": 400,
  "delayBetweenBatches": 240000
}
```

### Dry Run (Split Only)

Test the splitting without importing:
```bash
node split-contentful-export.js
# Review batches/ directory
# Don't run import-batches.js yet
```

### Import Specific Batches

Import only batches 3-5:
```bash
# Edit import-batches.js to add batch range logic, or
# Run manually:
cd batches/batch-03
npx contentful-import --config import-config.json
```

## Best Practices

1. **Test with a small batch first:** Modify `batchSize` to 100 and test with batch-01
2. **Monitor the first import:** Watch batch-01 import closely for issues
3. **Keep source data:** Don't delete `contentful-export/` until validation passes
4. **Check logs regularly:** Review `batches/logs/` during long imports
5. **Use staging environment:** Test the migration in a staging environment first
6. **Backup target space:** Create a backup before starting large imports

## Migration Checklist

- [ ] Export data from source space (US)
- [ ] Download all assets to `contentful-export/`
- [ ] Install required packages (`contentful-import`, `contentful-management`)
- [ ] Configure `batch-config.json` with target space details
- [ ] Run `node split-contentful-export.js`
- [ ] Review batches in `batches/` directory
- [ ] Run `node import-batches.js`
- [ ] Monitor logs in `batches/logs/`
- [ ] Run `node validate-migration.js`
- [ ] Test content in target space UI
- [ ] Publish content if needed
- [ ] Update application to use new space

## Support

For issues related to:
- **This migration script:** Check logs in `batches/logs/`
- **Contentful CLI:** https://github.com/contentful/contentful-cli
- **Contentful Import:** https://github.com/contentful/contentful-import
- **Contentful API:** https://www.contentful.com/developers/docs/

## Files Generated During Migration

```
batches/
â”œâ”€â”€ batch-01/
â”‚   â”œâ”€â”€ exported-space.json       # Batch data
â”‚   â”œâ”€â”€ import-config.json        # Generated import config
â”‚   â”œâ”€â”€ assets.ctfassets.net/     # Asset files
â”‚   â””â”€â”€ ...
â”œâ”€â”€ manifest.json                  # Batch metadata
â”œâ”€â”€ import-state.json              # Import progress tracker
â””â”€â”€ logs/
    â”œâ”€â”€ batch-01.log               # Import logs
    â”œâ”€â”€ batch-01-errors.log        # Error logs
    â””â”€â”€ ...
```

## Cleanup

After successful migration:
```bash
# Optional: Remove batches directory to save space (4.6GB+)
rm -rf batches/

# Keep these for reference:
# - batch-config.json
# - contentful-export/ (original export)
# - manifest.json
# - import-state.json
```

---

**Created:** 2025-10-28
**Version:** 1.0.0
**Author:** Automated Contentful Migration Tool
